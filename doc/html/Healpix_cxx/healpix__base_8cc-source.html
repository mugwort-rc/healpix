<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>Healpix C++: healpix_base.cc Source File</title>
<link href="sheet.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.9.1 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="modules.html">Modules</a> | <a class="qindex" href="hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="classes.html">Alphabetical&nbsp;List</a> | <a class="qindex" href="annotated.html">Class&nbsp;List</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Class&nbsp;Members</a> | <a class="qindex" href="globals.html">File&nbsp;Members</a> | <a class="qindex" href="pages.html">Related&nbsp;Pages</a></div>
<div class="nav">
<a class="el" href="dir_000000.html">Healpix_cxx</a></div>
<h1>healpix_base.cc</h1><div class="fragment"><pre class="fragment">00001 <span class="comment">/*</span>
00002 <span class="comment"> *  This file is part of Healpix_cxx.</span>
00003 <span class="comment"> *</span>
00004 <span class="comment"> *  Healpix_cxx is free software; you can redistribute it and/or modify</span>
00005 <span class="comment"> *  it under the terms of the GNU General Public License as published by</span>
00006 <span class="comment"> *  the Free Software Foundation; either version 2 of the License, or</span>
00007 <span class="comment"> *  (at your option) any later version.</span>
00008 <span class="comment"> *</span>
00009 <span class="comment"> *  Healpix_cxx is distributed in the hope that it will be useful,</span>
00010 <span class="comment"> *  but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
00011 <span class="comment"> *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
00012 <span class="comment"> *  GNU General Public License for more details.</span>
00013 <span class="comment"> *</span>
00014 <span class="comment"> *  You should have received a copy of the GNU General Public License</span>
00015 <span class="comment"> *  along with Healpix_cxx; if not, write to the Free Software</span>
00016 <span class="comment"> *  Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA  02110-1301  USA</span>
00017 <span class="comment"> *</span>
00018 <span class="comment"> *  For more information about HEALPix, see http://healpix.jpl.nasa.gov</span>
00019 <span class="comment"> */</span>
00020 
00021 <span class="comment">/*</span>
00022 <span class="comment"> *  Healpix_cxx is being developed at the Max-Planck-Institut fuer Astrophysik</span>
00023 <span class="comment"> *  and financially supported by the Deutsches Zentrum fuer Luft- und Raumfahrt</span>
00024 <span class="comment"> *  (DLR).</span>
00025 <span class="comment"> */</span>
00026 
00027 <span class="comment">/*</span>
00028 <span class="comment"> *  Copyright (C) 2003, 2004 Max-Planck-Society</span>
00029 <span class="comment"> *  Author: Martin Reinecke</span>
00030 <span class="comment"> */</span>
00031 
00032 <span class="preprocessor">#include "<a class="code" href="healpix__base_8h.html">healpix_base.h</a>"</span>
00033 <span class="preprocessor">#include "<a class="codeRef" doxygen="cxxsupport.tag:../cxxsupport/" href="../cxxsupport/cxxutils_8h.html">cxxutils.h</a>"</span>
00034 <span class="preprocessor">#include "<a class="codeRef" doxygen="cxxsupport.tag:../cxxsupport/" href="../cxxsupport/pointing_8h.html">pointing.h</a>"</span>
00035 <span class="preprocessor">#include "<a class="codeRef" doxygen="cxxsupport.tag:../cxxsupport/" href="../cxxsupport/arr_8h.html">arr.h</a>"</span>
00036 
00037 <span class="keyword">using</span> <span class="keyword">namespace </span>std;
00038 
00039 <span class="keywordtype">short</span> Healpix_Base::ctab[];
00040 <span class="keywordtype">short</span> Healpix_Base::utab[];
00041 
00042 <span class="keyword">const</span> nside_dummy SET_NSIDE=nside_dummy();
00043 
00044 Healpix_Base::Tablefiller::Tablefiller()
00045   {
00046   <span class="keywordflow">for</span> (<span class="keywordtype">int</span> m=0; m&lt;0x100; ++m)
00047     {
00048     ctab[m] =
00049          (m&amp;0x1 )       | ((m&amp;0x2 ) &lt;&lt; 7) | ((m&amp;0x4 ) &gt;&gt; 1) | ((m&amp;0x8 ) &lt;&lt; 6)
00050       | ((m&amp;0x10) &gt;&gt; 2) | ((m&amp;0x20) &lt;&lt; 5) | ((m&amp;0x40) &gt;&gt; 3) | ((m&amp;0x80) &lt;&lt; 4);
00051     utab[m] =
00052          (m&amp;0x1 )       | ((m&amp;0x2 ) &lt;&lt; 1) | ((m&amp;0x4 ) &lt;&lt; 2) | ((m&amp;0x8 ) &lt;&lt; 3)
00053       | ((m&amp;0x10) &lt;&lt; 4) | ((m&amp;0x20) &lt;&lt; 5) | ((m&amp;0x40) &lt;&lt; 6) | ((m&amp;0x80) &lt;&lt; 7);
00054     }
00055   }
00056 
00057 Healpix_Base::Tablefiller Healpix_Base::Filler;
00058 
00059 <span class="keyword">const</span> <span class="keywordtype">int</span> Healpix_Base::jrll[] = { 2,2,2,2,3,3,3,3,4,4,4,4 };
00060 <span class="keyword">const</span> <span class="keywordtype">int</span> Healpix_Base::jpll[] = { 1,3,5,7,0,2,4,6,1,3,5,7 };
00061 
<a name="l00062"></a><a class="code" href="classHealpix__Base.html#e0">00062</a> <span class="keywordtype">int</span> <a class="code" href="classHealpix__Base.html#e0">Healpix_Base::nside2order</a> (<span class="keywordtype">int</span> nside)
00063   {
00064   <span class="keywordflow">for</span> (<span class="keywordtype">int</span> m=0; m&lt;=order_max; ++m)
00065     {
00066     <span class="keywordtype">int</span> nstest = 1&lt;&lt;m;
00067     <span class="keywordflow">if</span> (nside == nstest) <span class="keywordflow">return</span> m;
00068     <span class="keywordflow">if</span> (nside &lt; nstest) <span class="keywordflow">return</span> -1;
00069     }
00070   <span class="keywordflow">return</span> -1;
00071   }
<a name="l00072"></a><a class="code" href="classHealpix__Base.html#e1">00072</a> <span class="keywordtype">int</span> <a class="code" href="classHealpix__Base.html#e1">Healpix_Base::npix2nside</a> (<span class="keywordtype">int</span> npix)
00073   {
00074   <span class="keywordtype">int</span> res=<a class="codeRef" doxygen="cxxsupport.tag:../cxxsupport/" href="../cxxsupport/group__mathutilsgroup.html#gga10">isqrt</a>(npix/12);
00075   <a class="codeRef" doxygen="cxxsupport.tag:../cxxsupport/" href="../cxxsupport/group__assertgroup.html#gga1">planck_assert</a> (npix==res*res*12, <span class="stringliteral">"npix2nside: invalid argument"</span>);
00076   <span class="keywordflow">return</span> res;
00077   }
00078 
00079 <span class="keywordtype">int</span> Healpix_Base::xy2pix (<span class="keywordtype">int</span> x, <span class="keywordtype">int</span> y)
00080   {
00081   <span class="keywordflow">return</span> utab[x&amp;0xff] | (utab[x&gt;&gt;8]&lt;&lt;16) | (utab[y&amp;0xff]&lt;&lt;1) | (utab[y&gt;&gt;8]&lt;&lt;17);
00082   }
00083 <span class="keywordtype">int</span> Healpix_Base::x2pix (<span class="keywordtype">int</span> x)
00084   {
00085   <span class="keywordflow">return</span> utab[x&amp;0xff] | (utab[x&gt;&gt;8]&lt;&lt;16);
00086   }
00087 <span class="keywordtype">int</span> Healpix_Base::y2pix (<span class="keywordtype">int</span> y)
00088   {
00089   <span class="keywordflow">return</span> (utab[y&amp;0xff]&lt;&lt;1) | (utab[y&gt;&gt;8]&lt;&lt;17);
00090   }
00091 
00092 <span class="keywordtype">void</span> Healpix_Base::pix2xy (<span class="keywordtype">int</span> pix, <span class="keywordtype">int</span> &amp;x, <span class="keywordtype">int</span> &amp;y)
00093   {
00094   <span class="keywordtype">int</span> raw = (pix&amp;0x5555) | ((pix&amp;0x55550000)&gt;&gt;15);
00095   x = ctab[raw&amp;0xff] | (ctab[raw&gt;&gt;8]&lt;&lt;4);
00096   raw = ((pix&amp;0xaaaa)&gt;&gt;1) | ((pix&amp;0xaaaa0000)&gt;&gt;16);
00097   y = ctab[raw&amp;0xff] | (ctab[raw&gt;&gt;8]&lt;&lt;4);
00098   }
00099 
00100 <span class="keywordtype">int</span> Healpix_Base::ring_above (<span class="keywordtype">double</span> z)<span class="keyword"> const</span>
00101 <span class="keyword">  </span>{
00102   <span class="keywordtype">double</span> az=abs(z);
00103   <span class="keywordflow">if</span> (az&gt;twothird) <span class="comment">// polar caps</span>
00104     {
00105     <span class="keywordtype">int</span> iring = int(nside_*sqrt(3*(1-az)));
00106     <span class="keywordflow">return</span> (z&gt;0) ? iring : 4*<a class="code" href="classHealpix__Base.html#p1">nside_</a>-iring-1;
00107     }
00108   <span class="keywordflow">else</span> <span class="comment">// ----- equatorial region ---------</span>
00109     <span class="keywordflow">return</span> int(nside_*(2-1.5*z));
00110   }
00111 
00112 <span class="keywordtype">void</span> Healpix_Base::in_ring(<span class="keywordtype">int</span> iz, <span class="keywordtype">double</span> phi0, <span class="keywordtype">double</span> dphi,
00113   vector&lt;int&gt; &amp;listir)<span class="keyword"> const</span>
00114 <span class="keyword">  </span>{
00115   <span class="keywordtype">int</span> nr, ir, ipix1;
00116   <span class="keywordtype">double</span> shift=0.5;
00117 
00118   <span class="keywordflow">if</span> (iz&lt;nside_) <span class="comment">// north pole</span>
00119     {
00120     ir = iz;
00121     nr = ir*4;
00122     ipix1 = 2*ir*(ir-1);        <span class="comment">//    lowest pixel number in the ring</span>
00123     }
00124   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (iz&gt;(3*nside_)) <span class="comment">// south pole</span>
00125     {
00126     ir = 4*<a class="code" href="classHealpix__Base.html#p1">nside_</a> - iz;
00127     nr = ir*4;
00128     ipix1 = npix_ - 2*ir*(ir+1); <span class="comment">// lowest pixel number in the ring</span>
00129     }
00130   <span class="keywordflow">else</span> <span class="comment">// equatorial region</span>
00131     {
00132     ir = iz - <a class="code" href="classHealpix__Base.html#p1">nside_</a> + 1;           <span class="comment">//    within {1, 2*nside + 1}</span>
00133     nr = nside_*4;
00134     <span class="keywordflow">if</span> ((ir&amp;1)==0) shift = 0;
00135     ipix1 = ncap_ + (ir-1)*nr; <span class="comment">// lowest pixel number in the ring</span>
00136     }
00137 
00138   <span class="keywordtype">int</span> ipix2 = ipix1 + nr - 1;       <span class="comment">//    highest pixel number in the ring</span>
00139 
00140    <span class="comment">// ----------- constructs the pixel list --------------</span>
00141   <span class="keywordflow">if</span> (dphi &gt; (pi-1e-7))
00142     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=ipix1; i&lt;=ipix2; ++i) listir.push_back(i);
00143   <span class="keywordflow">else</span>
00144     {
00145     <span class="keywordtype">int</span> ip_lo = <a class="codeRef" doxygen="cxxsupport.tag:../cxxsupport/" href="../cxxsupport/group__mathutilsgroup.html#gga2">intfloor</a>(nr*inv_twopi*(phi0-dphi) - shift)+1;
00146     <span class="keywordtype">int</span> ip_hi = <a class="codeRef" doxygen="cxxsupport.tag:../cxxsupport/" href="../cxxsupport/group__mathutilsgroup.html#gga2">intfloor</a>(nr*inv_twopi*(phi0+dphi) - shift);
00147     <span class="keywordtype">int</span> pixnum = ip_lo+ipix1;
00148     <span class="keywordflow">if</span> (pixnum&lt;ipix1) pixnum += nr;
00149     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=ip_lo; i&lt;=ip_hi; ++i, ++pixnum)
00150       {
00151       <span class="keywordflow">if</span> (pixnum&gt;ipix2) pixnum -= nr;
00152       listir.push_back(pixnum);
00153       }
00154     }
00155   }
00156 
00157 <span class="keywordtype">void</span> Healpix_Base::nest2xyf (<span class="keywordtype">int</span> pix, <span class="keywordtype">int</span> &amp;ix, <span class="keywordtype">int</span> &amp;iy, <span class="keywordtype">int</span> &amp;face_num)<span class="keyword"> const</span>
00158 <span class="keyword">  </span>{
00159   face_num = pix&gt;&gt;(2*order_);
00160   pix2xy(pix&amp;(npface_-1),ix,iy);
00161   }
00162 
00163 <span class="keywordtype">int</span> Healpix_Base::xyf2nest (<span class="keywordtype">int</span> ix, <span class="keywordtype">int</span> iy, <span class="keywordtype">int</span> face_num)<span class="keyword"> const</span>
00164 <span class="keyword">  </span>{
00165   <span class="keywordflow">return</span> (face_num&lt;&lt;(2*order_))+xy2pix(ix,iy);
00166   }
00167 
00168 <span class="keywordtype">void</span> Healpix_Base::ring2xyf (<span class="keywordtype">int</span> pix, <span class="keywordtype">int</span> &amp;ix, <span class="keywordtype">int</span> &amp;iy, <span class="keywordtype">int</span> &amp;face_num)<span class="keyword"> const</span>
00169 <span class="keyword">  </span>{
00170   <span class="keywordtype">int</span> iring, iphi, kshift, nr;
00171 
00172   <span class="keywordtype">int</span> nl2 = 2*nside_;
00173 
00174   <span class="keywordflow">if</span> (pix&lt;ncap_) <span class="comment">// North Polar cap</span>
00175     {
00176     iring = int(0.5*(1+<a class="codeRef" doxygen="cxxsupport.tag:../cxxsupport/" href="../cxxsupport/group__mathutilsgroup.html#gga10">isqrt</a>(1+2*pix))); <span class="comment">//counted from North pole</span>
00177     iphi  = (pix+1) - 2*iring*(iring-1);
00178     kshift = 0;
00179     nr = iring;
00180     face_num=0;
00181     <span class="keywordtype">int</span> tmp = iphi-1;
00182     <span class="keywordflow">if</span> (tmp&gt;=(2*iring))
00183       {
00184       face_num=2;
00185       tmp-=2*iring;
00186       }
00187     <span class="keywordflow">if</span> (tmp&gt;=iring) ++face_num;
00188     }
00189   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (pix&lt;(npix_-ncap_)) <span class="comment">// Equatorial region</span>
00190     {
00191     <span class="keywordtype">int</span> ip = pix - ncap_;
00192     <span class="keywordflow">if</span> (<a class="code" href="classHealpix__Base.html#p0">order_</a>&gt;=0)
00193       {
00194       iring = (ip&gt;&gt;(<a class="code" href="classHealpix__Base.html#p0">order_</a>+2)) + nside_; <span class="comment">// counted from North pole</span>
00195       iphi  = (ip&amp;(4*<a class="code" href="classHealpix__Base.html#p1">nside_</a>-1)) + 1;
00196       }
00197     <span class="keywordflow">else</span>
00198       {
00199       iring = (ip/(4*nside_)) + nside_; <span class="comment">// counted from North pole</span>
00200       iphi  = (ip%(4*nside_)) + 1;
00201       }
00202     kshift = (iring+nside_)&amp;1;
00203     nr = nside_;
00204     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> ire = iring-<a class="code" href="classHealpix__Base.html#p1">nside_</a>+1;
00205     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> irm = nl2+2-ire;
00206     <span class="keywordtype">int</span> ifm, ifp;
00207     <span class="keywordflow">if</span> (<a class="code" href="classHealpix__Base.html#p0">order_</a>&gt;=0)
00208       {
00209       ifm = (iphi - ire/2 + nside_ -1) &gt;&gt; order_;
00210       ifp = (iphi - irm/2 + nside_ -1) &gt;&gt; order_;
00211       }
00212     <span class="keywordflow">else</span>
00213       {
00214       ifm = (iphi - ire/2 + nside_ -1) / nside_;
00215       ifp = (iphi - irm/2 + nside_ -1) / nside_;
00216       }
00217     <span class="keywordflow">if</span> (ifp == ifm) <span class="comment">// faces 4 to 7</span>
00218       face_num = (ifp==4) ? 4 : ifp+4;
00219     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ifp&lt;ifm) <span class="comment">// (half-)faces 0 to 3</span>
00220       face_num = ifp;
00221     <span class="keywordflow">else</span> <span class="comment">// (half-)faces 8 to 11</span>
00222       face_num = ifm + 8;
00223     }
00224   <span class="keywordflow">else</span> <span class="comment">// South Polar cap</span>
00225     {
00226     <span class="keywordtype">int</span> ip = npix_ - pix;
00227     iring = int(0.5*(1+<a class="codeRef" doxygen="cxxsupport.tag:../cxxsupport/" href="../cxxsupport/group__mathutilsgroup.html#gga10">isqrt</a>(2*ip-1))); <span class="comment">//counted from South pole</span>
00228     iphi  = 4*iring + 1 - (ip - 2*iring*(iring-1));
00229     kshift = 0;
00230     nr = iring;
00231     iring = 2*nl2-iring;
00232     face_num=8;
00233     <span class="keywordtype">int</span> tmp = iphi-1;
00234     <span class="keywordflow">if</span> (tmp&gt;=(2*nr))
00235       {
00236       face_num=10;
00237       tmp-=2*nr;
00238       }
00239     <span class="keywordflow">if</span> (tmp&gt;=nr) ++face_num;
00240     }
00241 
00242   <span class="keywordtype">int</span> irt = iring - (jrll[face_num]*nside_) + 1;
00243   <span class="keywordtype">int</span> ipt = 2*iphi- jpll[face_num]*nr - kshift -1;
00244   <span class="keywordflow">if</span> (ipt&gt;=nl2) ipt-=8*nside_;
00245 
00246   ix =  (ipt-irt) &gt;&gt;1;
00247   iy =(-(ipt+irt))&gt;&gt;1;
00248   }
00249 
00250 <span class="keywordtype">int</span> Healpix_Base::xyf2ring (<span class="keywordtype">int</span> ix, <span class="keywordtype">int</span> iy, <span class="keywordtype">int</span> face_num)<span class="keyword"> const</span>
00251 <span class="keyword">  </span>{
00252   <span class="keywordtype">int</span> nl4 = 4*nside_;
00253   <span class="keywordtype">int</span> jr = (jrll[face_num]*nside_) - ix - iy  - 1;
00254 
00255   <span class="keywordtype">int</span> nr, kshift, n_before;
00256   <span class="keywordflow">if</span> (jr&lt;nside_)
00257     {
00258     nr = jr;
00259     n_before = 2*nr*(nr-1);
00260     kshift = 0;
00261     }
00262   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (jr &gt; 3*nside_)
00263     {
00264     nr = nl4-jr;
00265     n_before = npix_ - 2*(nr+1)*nr;
00266     kshift = 0;
00267     }
00268   <span class="keywordflow">else</span>
00269     {
00270     nr = nside_;
00271     n_before = ncap_ + (jr-nside_)*nl4;
00272     kshift = (jr-nside_)&amp;1;
00273     }
00274 
00275   <span class="keywordtype">int</span> jp = (jpll[face_num]*nr + ix - iy + 1 + kshift) / 2;
00276   <span class="keywordflow">if</span> (jp&gt;nl4)
00277     jp-=nl4;
00278   <span class="keywordflow">else</span>
00279     <span class="keywordflow">if</span> (jp&lt;1) jp+=nl4;
00280 
00281   <span class="keywordflow">return</span> n_before + jp - 1;
00282   }
00283 
<a name="l00284"></a><a class="code" href="classHealpix__Base.html#a5">00284</a> <span class="keywordtype">int</span> <a class="code" href="classHealpix__Base.html#a5">Healpix_Base::nest2ring</a> (<span class="keywordtype">int</span> pix)<span class="keyword"> const</span>
00285 <span class="keyword">  </span>{
00286   <a class="codeRef" doxygen="cxxsupport.tag:../cxxsupport/" href="../cxxsupport/group__assertgroup.html#gga1">planck_assert</a>(<a class="code" href="classHealpix__Base.html#p0">order_</a>&gt;=0, <span class="stringliteral">"nest2ring: need hierarchical map"</span>);
00287   <span class="keywordtype">int</span> ix, iy, face_num;
00288   nest2xyf (pix, ix, iy, face_num);
00289   <span class="keywordflow">return</span> xyf2ring (ix, iy, face_num);
00290   }
00291 
<a name="l00292"></a><a class="code" href="classHealpix__Base.html#a6">00292</a> <span class="keywordtype">int</span> <a class="code" href="classHealpix__Base.html#a6">Healpix_Base::ring2nest</a> (<span class="keywordtype">int</span> pix)<span class="keyword"> const</span>
00293 <span class="keyword">  </span>{
00294   <a class="codeRef" doxygen="cxxsupport.tag:../cxxsupport/" href="../cxxsupport/group__assertgroup.html#gga1">planck_assert</a>(<a class="code" href="classHealpix__Base.html#p0">order_</a>&gt;=0, <span class="stringliteral">"ring2nest: need hierarchical map"</span>);
00295   <span class="keywordtype">int</span> ix, iy, face_num;
00296   ring2xyf (pix, ix, iy, face_num);
00297   <span class="keywordflow">return</span> xyf2nest (ix, iy, face_num);
00298   }
00299 
00300 <span class="keywordtype">int</span> Healpix_Base::ang2pix_z_phi (<span class="keywordtype">double</span> z, <span class="keywordtype">double</span> phi)<span class="keyword"> const</span>
00301 <span class="keyword">  </span>{
00302   <span class="keywordtype">double</span> za = abs(z);
00303   <span class="keywordtype">double</span> tt = <a class="codeRef" doxygen="cxxsupport.tag:../cxxsupport/" href="../cxxsupport/group__mathutilsgroup.html#gga8">modulo</a>(phi,twopi) * inv_halfpi; <span class="comment">// in [0,4)</span>
00304 
00305   <span class="keywordflow">if</span> (scheme_==RING)
00306     {
00307     <span class="keywordflow">if</span> (za&lt;=twothird) <span class="comment">// Equatorial region</span>
00308       {
00309       <span class="keywordtype">double</span> temp1 = nside_*(0.5+tt);
00310       <span class="keywordtype">double</span> temp2 = nside_*z*0.75;
00311       <span class="keywordtype">int</span> jp = int(temp1-temp2); <span class="comment">// index of  ascending edge line</span>
00312       <span class="keywordtype">int</span> jm = int(temp1+temp2); <span class="comment">// index of descending edge line</span>
00313 
00314       <span class="comment">// ring number counted from z=2/3</span>
00315       <span class="keywordtype">int</span> ir = nside_ + 1 + jp - jm; <span class="comment">// in {1,2n+1}</span>
00316       <span class="keywordtype">int</span> kshift = 1-(ir&amp;1); <span class="comment">// kshift=1 if ir even, 0 otherwise</span>
00317 
00318       <span class="keywordtype">int</span> ip = (jp+jm-nside_+kshift+1)/2; <span class="comment">// in {0,4n-1}</span>
00319       ip = <a class="codeRef" doxygen="cxxsupport.tag:../cxxsupport/" href="../cxxsupport/group__mathutilsgroup.html#gga8">modulo</a>(ip,4*nside_);
00320 
00321       <span class="keywordflow">return</span> ncap_ + (ir-1)*4*nside_ + ip;
00322       }
00323     <span class="keywordflow">else</span>  <span class="comment">// North &amp; South polar caps</span>
00324       {
00325       <span class="keywordtype">double</span> tp = tt-int(tt);
00326       <span class="keywordtype">double</span> tmp = <a class="code" href="classHealpix__Base.html#p1">nside_</a>*sqrt(3*(1-za));
00327 
00328       <span class="keywordtype">int</span> jp = int(tp*tmp); <span class="comment">// increasing edge line index</span>
00329       <span class="keywordtype">int</span> jm = int((1.0-tp)*tmp); <span class="comment">// decreasing edge line index</span>
00330 
00331       <span class="keywordtype">int</span> ir = jp+jm+1; <span class="comment">// ring number counted from the closest pole</span>
00332       <span class="keywordtype">int</span> ip = int(tt*ir); <span class="comment">// in {0,4*ir-1}</span>
00333       ip = <a class="codeRef" doxygen="cxxsupport.tag:../cxxsupport/" href="../cxxsupport/group__mathutilsgroup.html#gga8">modulo</a>(ip,4*ir);
00334 
00335       <span class="keywordflow">if</span> (z&gt;0)
00336         <span class="keywordflow">return</span> 2*ir*(ir-1) + ip;
00337       <span class="keywordflow">else</span>
00338         <span class="keywordflow">return</span> npix_ - 2*ir*(ir+1) + ip;
00339       }
00340     }
00341   <span class="keywordflow">else</span> <span class="comment">// scheme_ == NEST</span>
00342     {
00343     <span class="keyword">const</span> <span class="keywordtype">int</span> ns_max = 1&lt;&lt;order_max;
00344     <span class="keywordtype">int</span> face_num, ix, iy;
00345 
00346     <span class="keywordflow">if</span> (za&lt;=twothird) <span class="comment">// Equatorial region</span>
00347       {
00348       <span class="keywordtype">double</span> temp1 = ns_max*(0.5+tt);
00349       <span class="keywordtype">double</span> temp2 = ns_max*z*0.75;
00350       <span class="keywordtype">int</span> jp = int(temp1-temp2); <span class="comment">// index of  ascending edge line</span>
00351       <span class="keywordtype">int</span> jm = int(temp1+temp2); <span class="comment">// index of descending edge line</span>
00352       <span class="keywordtype">int</span> ifp = jp &gt;&gt; order_max;  <span class="comment">// in {0,4}</span>
00353       <span class="keywordtype">int</span> ifm = jm &gt;&gt; order_max;
00354       <span class="keywordflow">if</span> (ifp == ifm)           <span class="comment">// faces 4 to 7</span>
00355         face_num = (ifp==4) ? 4: ifp+4;
00356       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ifp &lt; ifm)       <span class="comment">// (half-)faces 0 to 3</span>
00357         face_num = ifp;
00358       <span class="keywordflow">else</span>                      <span class="comment">// (half-)faces 8 to 11</span>
00359         face_num = ifm + 8;
00360 
00361       ix = jm &amp; (ns_max-1);
00362       iy = ns_max - (jp &amp; (ns_max-1)) - 1;
00363       }
00364     <span class="keywordflow">else</span> <span class="comment">// polar region, za &gt; 2/3</span>
00365       {
00366       <span class="keywordtype">int</span> ntt = int(tt);
00367       <span class="keywordtype">double</span> tp = tt-ntt;
00368       <span class="keywordtype">double</span> tmp = ns_max*sqrt(3*(1-za));
00369 
00370       <span class="keywordtype">int</span> jp = int(tp*tmp); <span class="comment">// increasing edge line index</span>
00371       <span class="keywordtype">int</span> jm = int((1.0-tp)*tmp); <span class="comment">// decreasing edge line index</span>
00372       <span class="keywordflow">if</span> (jp&gt;=ns_max) jp = ns_max-1; <span class="comment">// for points too close to the boundary</span>
00373       <span class="keywordflow">if</span> (jm&gt;=ns_max) jm = ns_max-1;
00374       <span class="keywordflow">if</span> (z &gt;= 0)
00375         {
00376         face_num = ntt;  <span class="comment">// in {0,3}</span>
00377         ix = ns_max - jm - 1;
00378         iy = ns_max - jp - 1;
00379         }
00380       <span class="keywordflow">else</span>
00381         {
00382         face_num = ntt + 8; <span class="comment">// in {8,11}</span>
00383         ix =  jp;
00384         iy =  jm;
00385         }
00386       }
00387 
00388     <span class="keywordtype">int</span> ipf = xy2pix (ix, iy);
00389 
00390     ipf &gt;&gt;= (2*(order_max-order_));  <span class="comment">// in {0, nside**2 - 1}</span>
00391 
00392     <span class="keywordflow">return</span> ipf + (face_num&lt;&lt;(2*order_));    <span class="comment">// in {0, 12*nside**2 - 1}</span>
00393     }
00394   }
00395 
<a name="l00396"></a><a class="code" href="classHealpix__Base.html#a10">00396</a> <a class="codeRef" doxygen="cxxsupport.tag:../cxxsupport/" href="../cxxsupport/classpointing.html">pointing</a> <a class="code" href="classHealpix__Base.html#a10">Healpix_Base::pix2ang</a> (<span class="keywordtype">int</span> pix)<span class="keyword"> const</span>
00397 <span class="keyword">  </span>{
00398   <span class="keywordflow">if</span> (<a class="code" href="classHealpix__Base.html#p7">scheme_</a>==RING)
00399     {
00400     <span class="keywordflow">if</span> (pix&lt;ncap_) <span class="comment">// North Polar cap</span>
00401       {
00402       <span class="keywordtype">int</span> iring = int(0.5*(1+<a class="codeRef" doxygen="cxxsupport.tag:../cxxsupport/" href="../cxxsupport/group__mathutilsgroup.html#gga10">isqrt</a>(1+2*pix))); <span class="comment">//counted from North pole</span>
00403       <span class="keywordtype">int</span> iphi  = (pix+1) - 2*iring*(iring-1);
00404 
00405       <span class="keywordflow">return</span> <a class="codeRef" doxygen="cxxsupport.tag:../cxxsupport/" href="../cxxsupport/classpointing.html">pointing</a> (acos(1.0 - (iring*iring)*fact2_),
00406                        (iphi-0.5) * pi/(2.0*iring));
00407       }
00408     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (pix&lt;(npix_-ncap_)) <span class="comment">// Equatorial region</span>
00409       {
00410       <span class="keywordtype">int</span> ip  = pix - ncap_;
00411       <span class="keywordtype">int</span> iring = ip/(4*nside_) + nside_; <span class="comment">// counted from North pole</span>
00412       <span class="keywordtype">int</span> iphi  = ip%(4*nside_) + 1;
00413       <span class="comment">// 1 if iring+nside is odd, 1/2 otherwise</span>
00414       <span class="keywordtype">double</span> fodd = ((iring+nside_)&amp;1) ? 1 : 0.5;
00415 
00416       <span class="keywordtype">int</span> nl2 = 2*nside_;
00417       <span class="keywordflow">return</span> <a class="codeRef" doxygen="cxxsupport.tag:../cxxsupport/" href="../cxxsupport/classpointing.html">pointing</a> (acos((nl2-iring)*fact1_),
00418                        (iphi-fodd) * pi/nl2);
00419       }
00420     <span class="keywordflow">else</span> <span class="comment">// South Polar cap</span>
00421       {
00422       <span class="keywordtype">int</span> ip = npix_ - pix;
00423       <span class="keywordtype">int</span> iring = int(0.5*(1+<a class="codeRef" doxygen="cxxsupport.tag:../cxxsupport/" href="../cxxsupport/group__mathutilsgroup.html#gga10">isqrt</a>(2*ip-1))); <span class="comment">//counted from South pole</span>
00424       <span class="keywordtype">int</span> iphi  = 4*iring + 1 - (ip - 2*iring*(iring-1));
00425 
00426       <span class="keywordflow">return</span> <a class="codeRef" doxygen="cxxsupport.tag:../cxxsupport/" href="../cxxsupport/classpointing.html">pointing</a> (acos(-1.0 + (iring*iring)*fact2_),
00427                        (iphi-0.5) * pi/(2*iring));
00428       }
00429     }
00430   <span class="keywordflow">else</span>
00431     {
00432     <span class="keywordtype">int</span> nl4 = <a class="code" href="classHealpix__Base.html#p1">nside_</a>*4;
00433 
00434     <span class="keywordtype">int</span> face_num = pix&gt;&gt;(2*order_);
00435     <span class="keywordtype">int</span> ipf = pix&amp;(npface_-1);
00436 
00437     <span class="keywordtype">int</span> ix, iy;
00438     pix2xy(ipf,ix,iy);
00439 
00440     <span class="keywordtype">int</span> jr = (jrll[face_num]&lt;&lt;order_) - ix - iy - 1;
00441 
00442     <span class="keywordtype">int</span> nr, kshift;
00443     <span class="keywordtype">double</span> z;
00444     <span class="keywordflow">if</span> (jr&lt;nside_)
00445       {
00446       nr = jr;
00447       z = 1 - nr*nr*fact2_;
00448       kshift = 0;
00449       }
00450     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (jr &gt; 3*nside_)
00451       {
00452       nr = nl4-jr;
00453       z = nr*nr*fact2_ - 1;
00454       kshift = 0;
00455       }
00456     <span class="keywordflow">else</span>
00457       {
00458       nr = nside_;
00459       z = (2*<a class="code" href="classHealpix__Base.html#p1">nside_</a>-jr)*fact1_;
00460       kshift = (jr-nside_)&amp;1;
00461       }
00462 
00463     <span class="keywordtype">int</span> jp = (jpll[face_num]*nr + ix -iy + 1 + kshift) / 2;
00464     <span class="keywordflow">if</span> (jp&gt;nl4) jp-=nl4;
00465     <span class="keywordflow">if</span> (jp&lt;1) jp+=nl4;
00466 
00467     <span class="keywordflow">return</span> <a class="codeRef" doxygen="cxxsupport.tag:../cxxsupport/" href="../cxxsupport/classpointing.html">pointing</a> (acos(z), (jp-(kshift+1)*0.5)*(halfpi/nr));
00468     }
00469   }
00470 
<a name="l00471"></a><a class="code" href="classHealpix__Base.html#a11">00471</a> <span class="keywordtype">void</span> <a class="code" href="classHealpix__Base.html#a11">Healpix_Base::query_disc</a> (<span class="keyword">const</span> <a class="codeRef" doxygen="cxxsupport.tag:../cxxsupport/" href="../cxxsupport/classpointing.html">pointing</a> &amp;ptg, <span class="keywordtype">double</span> radius,
00472   vector&lt;int&gt;&amp; listpix)<span class="keyword"> const</span>
00473 <span class="keyword">  </span>{
00474   listpix.clear();
00475 
00476   <span class="keywordtype">double</span> dth1 = fact2_;
00477   <span class="keywordtype">double</span> dth2 = fact1_;
00478   <span class="keywordtype">double</span> cosang = cos(radius);
00479 
00480   <span class="keywordtype">double</span> z0 = cos(ptg.<a class="codeRef" doxygen="cxxsupport.tag:../cxxsupport/" href="../cxxsupport/classpointing.html#o0">theta</a>);
00481   <span class="keywordtype">double</span> xa = 1./sqrt((1-z0)*(1+z0));
00482 
00483   <span class="keywordtype">double</span> rlat1  = ptg.<a class="codeRef" doxygen="cxxsupport.tag:../cxxsupport/" href="../cxxsupport/classpointing.html#o0">theta</a> - radius;
00484   <span class="keywordtype">double</span> zmax = cos(rlat1);
00485   <span class="keywordtype">int</span> irmin = ring_above (zmax)+1;
00486 
00487   <span class="keywordflow">if</span> (rlat1&lt;=0) <span class="comment">// north pole in the disc</span>
00488     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> m=1; m&lt;irmin; ++m) <span class="comment">// rings completely in the disc</span>
00489       in_ring (m, 0, pi, listpix);
00490 
00491   <span class="keywordtype">double</span> rlat2  = ptg.<a class="codeRef" doxygen="cxxsupport.tag:../cxxsupport/" href="../cxxsupport/classpointing.html#o0">theta</a> + radius;
00492   <span class="keywordtype">double</span> zmin = cos(rlat2);
00493   <span class="keywordtype">int</span> irmax = ring_above (zmin);
00494 
00495 <span class="comment">// ------------- loop on ring number ---------------------</span>
00496   <span class="keywordflow">for</span> (<span class="keywordtype">int</span> iz=irmin; iz&lt;=irmax; ++iz) <span class="comment">// rings partially in the disc</span>
00497     {
00498     <span class="keywordtype">double</span> z;
00499     <span class="keywordflow">if</span> (iz&lt;nside_) <span class="comment">// north polar cap</span>
00500       z = 1.0 - iz*iz*dth1;
00501     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (iz &lt;= (3*nside_)) <span class="comment">// tropical band + equat.</span>
00502       z = (2*<a class="code" href="classHealpix__Base.html#p1">nside_</a>-iz) * dth2;
00503     <span class="keywordflow">else</span>
00504       z = -1.0 + (4*<a class="code" href="classHealpix__Base.html#p1">nside_</a>-iz)*(4*<a class="code" href="classHealpix__Base.html#p1">nside_</a>-iz)*dth1;
00505 
00506 <span class="comment">// --------- phi range in the disc for each z ---------</span>
00507     <span class="keywordtype">double</span> x = (cosang-z*z0)*xa;
00508     <span class="keywordtype">double</span> ysq = 1-z*z-x*x;
00509     <a class="codeRef" doxygen="cxxsupport.tag:../cxxsupport/" href="../cxxsupport/group__assertgroup.html#gga1">planck_assert</a>(ysq&gt;=0, <span class="stringliteral">"error in query_disc()"</span>);
00510     <span class="keywordtype">double</span> dphi=atan2(sqrt(ysq),x);
00511     in_ring (iz, ptg.<a class="codeRef" doxygen="cxxsupport.tag:../cxxsupport/" href="../cxxsupport/classpointing.html#o1">phi</a>, dphi, listpix);
00512     }
00513 
00514   <span class="keywordflow">if</span> (rlat2&gt;=pi) <span class="comment">// south pole in the disc</span>
00515     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> m=irmax+1; m&lt;(4*nside_); ++m)  <span class="comment">// rings completely in the disc</span>
00516       in_ring (m, 0, pi, listpix);
00517 
00518   <span class="keywordflow">if</span> (<a class="code" href="classHealpix__Base.html#p7">scheme_</a>==NEST)
00519     <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> m=0; m&lt;listpix.size(); ++m)
00520       listpix[m] = <a class="code" href="classHealpix__Base.html#a6">ring2nest</a>(listpix[m]);
00521   }
00522 
<a name="l00523"></a><a class="code" href="classHealpix__Base.html#a14">00523</a> <span class="keywordtype">void</span> <a class="code" href="classHealpix__Base.html#a14">Healpix_Base::get_ring_info</a> (<span class="keywordtype">int</span> ring, <span class="keywordtype">int</span> &amp;startpix, <span class="keywordtype">int</span> &amp;ringpix,
00524   <span class="keywordtype">double</span> &amp;costheta, <span class="keywordtype">double</span> &amp;sintheta, <span class="keywordtype">bool</span> &amp;shifted)<span class="keyword"> const</span>
00525 <span class="keyword">  </span>{
00526   <a class="codeRef" doxygen="cxxsupport.tag:../cxxsupport/" href="../cxxsupport/group__assertgroup.html#gga1">planck_assert</a>(<a class="code" href="classHealpix__Base.html#p7">scheme_</a>==<a class="code" href="healpix__base_8h.html#a3a1">RING</a>,<span class="stringliteral">"map must be in RING scheme"</span>);
00527   <span class="keywordtype">int</span> northring = (ring&gt;2*nside_) ? 4*<a class="code" href="classHealpix__Base.html#p1">nside_</a>-ring : ring;
00528   <span class="keywordflow">if</span> (northring &lt; nside_)
00529     {
00530     costheta = 1 - northring*northring*fact2_;
00531     sintheta = sin(2*asin(northring/(sqrt(6.)*<a class="code" href="classHealpix__Base.html#p1">nside_</a>)));
00532     ringpix = 4*northring;
00533     shifted = <span class="keyword">true</span>;
00534     startpix = 2*northring*(northring-1);
00535     }
00536   <span class="keywordflow">else</span>
00537     {
00538     costheta = (2*<a class="code" href="classHealpix__Base.html#p1">nside_</a>-northring)*fact1_;
00539     sintheta = sqrt((1+costheta)*(1-costheta));
00540     ringpix = 4*nside_;
00541     shifted = ((northring-nside_) &amp; 1) == 0;
00542     startpix = ncap_ + (northring-nside_)*ringpix;
00543     }
00544   <span class="keywordflow">if</span> (northring != ring) <span class="comment">// southern hemisphere</span>
00545     {
00546     costheta = -costheta;
00547     startpix = npix_ - startpix - ringpix;
00548     }
00549   }
00550 
<a name="l00551"></a><a class="code" href="classHealpix__Base.html#a16">00551</a> <span class="keywordtype">void</span> <a class="code" href="classHealpix__Base.html#a16">Healpix_Base::neighbors</a> (<span class="keywordtype">int</span> pix, <a class="codeRef" doxygen="cxxsupport.tag:../cxxsupport/" href="../cxxsupport/classfix__arr.html">fix_arr&lt;int,8&gt;</a> &amp;result)<span class="keyword"> const</span>
00552 <span class="keyword">  </span>{
00553   <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">int</span> xoffset[] = { -1,-1, 0, 1, 1, 1, 0,-1 };
00554   <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">int</span> yoffset[] = {  0, 1, 1, 1, 0,-1,-1,-1 };
00555   <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">int</span> facearray[][12] =
00556         { {  8, 9,10,11,-1,-1,-1,-1,10,11, 8, 9 },   <span class="comment">// S</span>
00557           {  5, 6, 7, 4, 8, 9,10,11, 9,10,11, 8 },   <span class="comment">// SE</span>
00558           { -1,-1,-1,-1, 5, 6, 7, 4,-1,-1,-1,-1 },   <span class="comment">// E</span>
00559           {  4, 5, 6, 7,11, 8, 9,10,11, 8, 9,10 },   <span class="comment">// SW</span>
00560           {  0, 1, 2, 3, 4, 5, 6, 7, 8, 9,10,11 },   <span class="comment">// center</span>
00561           {  1, 2, 3, 0, 0, 1, 2, 3, 5, 6, 7, 4 },   <span class="comment">// NE</span>
00562           { -1,-1,-1,-1, 7, 4, 5, 6,-1,-1,-1,-1 },   <span class="comment">// W</span>
00563           {  3, 0, 1, 2, 3, 0, 1, 2, 4, 5, 6, 7 },   <span class="comment">// NW</span>
00564           {  2, 3, 0, 1,-1,-1,-1,-1, 0, 1, 2, 3 } }; <span class="comment">// N</span>
00565   <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">int</span> swaparray[][12] =
00566         { {  0,0,0,0,0,0,0,0,3,3,3,3 },   <span class="comment">// S</span>
00567           {  0,0,0,0,0,0,0,0,6,6,6,6 },   <span class="comment">// SE</span>
00568           {  0,0,0,0,0,0,0,0,0,0,0,0 },   <span class="comment">// E</span>
00569           {  0,0,0,0,0,0,0,0,5,5,5,5 },   <span class="comment">// SW</span>
00570           {  0,0,0,0,0,0,0,0,0,0,0,0 },   <span class="comment">// center</span>
00571           {  5,5,5,5,0,0,0,0,0,0,0,0 },   <span class="comment">// NE</span>
00572           {  0,0,0,0,0,0,0,0,0,0,0,0 },   <span class="comment">// W</span>
00573           {  6,6,6,6,0,0,0,0,0,0,0,0 },   <span class="comment">// NW</span>
00574           {  3,3,3,3,0,0,0,0,0,0,0,0 } }; <span class="comment">// N</span>
00575 
00576   <span class="keywordtype">int</span> ix, iy, face_num;
00577   (<a class="code" href="classHealpix__Base.html#p7">scheme_</a>==RING) ?
00578     ring2xyf(pix,ix,iy,face_num) : nest2xyf(pix,ix,iy,face_num);
00579 
00580   <span class="keyword">const</span> <span class="keywordtype">int</span> nsm1 = <a class="code" href="classHealpix__Base.html#p1">nside_</a>-1;
00581   <span class="keywordflow">if</span> ((ix&gt;0)&amp;&amp;(ix&lt;nsm1)&amp;&amp;(iy&gt;0)&amp;&amp;(iy&lt;nsm1))
00582     {
00583     <span class="keywordflow">if</span> (<a class="code" href="classHealpix__Base.html#p7">scheme_</a>==RING)
00584       <span class="keywordflow">for</span> (<span class="keywordtype">int</span> m=0; m&lt;8; ++m)
00585         result[m] = xyf2ring(ix+xoffset[m],iy+xoffset[m],face_num);
00586     <span class="keywordflow">else</span>
00587       <span class="keywordflow">for</span> (<span class="keywordtype">int</span> m=0; m&lt;8; ++m)
00588         result[m] = xyf2nest(ix+xoffset[m],iy+xoffset[m],face_num);
00589     }
00590   <span class="keywordflow">else</span>
00591     {
00592     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=0; i&lt;8; ++i)
00593       {
00594       <span class="keywordtype">int</span> x=ix+xoffset[i];
00595       <span class="keywordtype">int</span> y=iy+yoffset[i];
00596       <span class="keywordtype">int</span> nbnum=4;
00597       <span class="keywordflow">if</span> (x&lt;0)
00598         { x+=nside_; nbnum-=1; }
00599       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (x&gt;=nside_)
00600         { x-=nside_; nbnum+=1; }
00601       <span class="keywordflow">if</span> (y&lt;0)
00602         { y+=nside_; nbnum-=3; }
00603       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (y&gt;=nside_)
00604         { y-=nside_; nbnum+=3; }
00605 
00606       <span class="keywordtype">int</span> f = facearray[nbnum][face_num];
00607       <span class="keywordflow">if</span> (f&gt;=0)
00608         {
00609         <span class="keywordflow">if</span> (swaparray[nbnum][face_num]&amp;1) x=<a class="code" href="classHealpix__Base.html#p1">nside_</a>-x-1;
00610         <span class="keywordflow">if</span> (swaparray[nbnum][face_num]&amp;2) y=<a class="code" href="classHealpix__Base.html#p1">nside_</a>-y-1;
00611         <span class="keywordflow">if</span> (swaparray[nbnum][face_num]&amp;4) std::swap(x,y);
00612         result[i] = (<a class="code" href="classHealpix__Base.html#p7">scheme_</a>==RING) ? xyf2ring(x,y,f) : xyf2nest(x,y,f);
00613         }
00614       <span class="keywordflow">else</span>
00615         result[i] = -1;
00616       }
00617     }
00618   }
00619 
00620 <span class="keyword">namespace </span>{
00621 
00622 <span class="keywordtype">void</span> add_weights (<span class="keywordtype">int</span> p1, <span class="keywordtype">int</span> p2, <span class="keywordtype">int</span> p3, <span class="keywordtype">int</span> p4, <span class="keywordtype">double</span> xdiff, <span class="keywordtype">double</span> ydiff,
00623                   <a class="codeRef" doxygen="cxxsupport.tag:../cxxsupport/" href="../cxxsupport/classfix__arr.html">fix_arr&lt;int,4&gt;</a> &amp;pix, <a class="codeRef" doxygen="cxxsupport.tag:../cxxsupport/" href="../cxxsupport/classfix__arr.html">fix_arr&lt;double,4&gt;</a> &amp;wgt)
00624   {
00625   pix[0] = p1;
00626   pix[1] = p2;
00627   pix[2] = p3;
00628 
00629   <span class="keywordflow">if</span> (p4&gt;=0)
00630     {
00631     wgt[0] = (1-xdiff)*(1-ydiff);
00632     wgt[1] = xdiff*(1-ydiff);
00633     wgt[2] = ydiff*(1-xdiff);
00634     pix[3] = p4;
00635     wgt[3] = xdiff*ydiff;
00636     }
00637   <span class="keywordflow">else</span>
00638     {
00639     wgt[0] = 1-xdiff-ydiff+fourthird*xdiff*ydiff;
00640     wgt[1] = xdiff-twothird*xdiff*ydiff;
00641     wgt[2] = ydiff-twothird*xdiff*ydiff;
00642     pix[3] = 0;
00643     wgt[3] = 0;
00644     }
00645   }
00646 
00647 } <span class="comment">// namespace</span>
00648 
<a name="l00649"></a><a class="code" href="classHealpix__Base.html#a17">00649</a> <span class="keywordtype">void</span> <a class="code" href="classHealpix__Base.html#a17">Healpix_Base::get_interpol</a> (<span class="keyword">const</span> <a class="codeRef" doxygen="cxxsupport.tag:../cxxsupport/" href="../cxxsupport/classpointing.html">pointing</a> &amp;ptg, <a class="codeRef" doxygen="cxxsupport.tag:../cxxsupport/" href="../cxxsupport/classfix__arr.html">fix_arr&lt;int,4&gt;</a> &amp;pix,
00650   <a class="codeRef" doxygen="cxxsupport.tag:../cxxsupport/" href="../cxxsupport/classfix__arr.html">fix_arr&lt;double,4&gt;</a> &amp;wgt)<span class="keyword"> const</span>
00651 <span class="keyword">  </span>{
00652   <span class="keywordtype">double</span> z = cos(ptg.<a class="codeRef" doxygen="cxxsupport.tag:../cxxsupport/" href="../cxxsupport/classpointing.html#o0">theta</a>);
00653   <span class="keywordtype">double</span> za = abs(z);
00654   <span class="keywordtype">double</span> tt = <a class="codeRef" doxygen="cxxsupport.tag:../cxxsupport/" href="../cxxsupport/group__mathutilsgroup.html#gga8">modulo</a>(ptg.<a class="codeRef" doxygen="cxxsupport.tag:../cxxsupport/" href="../cxxsupport/classpointing.html#o1">phi</a>,twopi) / halfpi; <span class="comment">// in [0,4)</span>
00655 
00656   <span class="keywordtype">int</span> face_num;
00657   <span class="keywordtype">double</span> ix, iy;
00658   <span class="keywordflow">if</span> (za&lt;=twothird) <span class="comment">// Equatorial region</span>
00659     {
00660     <span class="keywordtype">double</span> temp1 = <a class="code" href="classHealpix__Base.html#p1">nside_</a>*(0.5+tt);
00661     <span class="keywordtype">double</span> temp2 = <a class="code" href="classHealpix__Base.html#p1">nside_</a>*z*0.75;
00662     <span class="keywordtype">double</span> jp = temp1-temp2; <span class="comment">// index of  ascending edge line</span>
00663     <span class="keywordtype">double</span> jm = temp1+temp2; <span class="comment">// index of descending edge line</span>
00664     <span class="keywordtype">int</span> ifp = int(jp/<a class="code" href="classHealpix__Base.html#p1">nside_</a>);  <span class="comment">// in {0,4}</span>
00665     <span class="keywordtype">int</span> ifm = int(jm/nside_);
00666     <span class="keywordflow">if</span> (ifp == ifm)           <span class="comment">// faces 4 to 7</span>
00667       face_num = (ifp==4) ? 4 : (ifp+4);
00668     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ifp &lt; ifm)       <span class="comment">// (half-)faces 0 to 3</span>
00669       face_num = ifp;
00670     <span class="keywordflow">else</span>                      <span class="comment">// (half-)faces 8 to 11</span>
00671       face_num = ifm + 8;
00672 
00673     ix = <a class="codeRef" doxygen="cxxsupport.tag:../cxxsupport/" href="../cxxsupport/group__mathutilsgroup.html#gga8">modulo</a>(jm, <span class="keywordtype">double</span>(nside_));
00674     iy = nside_ - <a class="codeRef" doxygen="cxxsupport.tag:../cxxsupport/" href="../cxxsupport/group__mathutilsgroup.html#gga8">modulo</a>(jp, <span class="keywordtype">double</span>(nside_));
00675     }
00676   <span class="keywordflow">else</span> <span class="comment">// polar region, za &gt; 2/3</span>
00677     {
00678     <span class="keywordtype">int</span> ntt = int(tt);
00679     <span class="keywordtype">double</span> tp = tt-ntt;
00680     <span class="keywordtype">double</span> tmp = <a class="code" href="classHealpix__Base.html#p1">nside_</a>*sqrt(3*(1-za));
00681 
00682     <span class="keywordtype">double</span> jp = tp*tmp; <span class="comment">// increasing edge line index</span>
00683     <span class="keywordtype">double</span> jm = (1.0-tp)*tmp; <span class="comment">// decreasing edge line index</span>
00684     <span class="keywordflow">if</span> (jp&gt;=nside_) jp = nside_; <span class="comment">// for points too close to the boundary</span>
00685     <span class="keywordflow">if</span> (jm&gt;=nside_) jm = nside_;
00686     <span class="keywordflow">if</span> (z &gt;= 0)
00687       {
00688       face_num = ntt;  <span class="comment">// in {0,3}</span>
00689       ix = <a class="code" href="classHealpix__Base.html#p1">nside_</a> - jm;
00690       iy = <a class="code" href="classHealpix__Base.html#p1">nside_</a> - jp;
00691       }
00692     <span class="keywordflow">else</span>
00693       {
00694       face_num = ntt + 8; <span class="comment">// in {8,11}</span>
00695       ix = jp;
00696       iy = jm;
00697       }
00698     }
00699 
00700   <span class="keywordflow">if</span> ((ix&gt;0.5) &amp;&amp; (ix&lt;(<a class="code" href="classHealpix__Base.html#p1">nside_</a>-0.5)) &amp;&amp; (iy&gt;0.5) &amp;&amp; (iy&lt;(<a class="code" href="classHealpix__Base.html#p1">nside_</a>-0.5)))
00701     {
00702     <span class="keywordtype">int</span> xpix=int(ix-0.5), ypix=int(iy-0.5);
00703     <span class="keywordtype">double</span> xdiff=ix-0.5-xpix, ydiff=iy-0.5-ypix;
00704     wgt[0] = (1-xdiff)*(1-ydiff);
00705     wgt[1] = xdiff*(1-ydiff);
00706     wgt[2] = (1-xdiff)*ydiff;
00707     wgt[3] = xdiff*ydiff;
00708     <span class="keywordflow">if</span> (<a class="code" href="classHealpix__Base.html#p7">scheme_</a>==RING)
00709       {
00710       pix[0] = xyf2ring(xpix  ,ypix  ,face_num);
00711       pix[1] = xyf2ring(xpix+1,ypix  ,face_num);
00712       pix[2] = xyf2ring(xpix  ,ypix+1,face_num);
00713       pix[3] = xyf2ring(xpix+1,ypix+1,face_num);
00714       }
00715     <span class="keywordflow">else</span>
00716       {
00717       pix[0] = xyf2nest(xpix  ,ypix  ,face_num);
00718       pix[1] = xyf2nest(xpix+1,ypix  ,face_num);
00719       pix[2] = xyf2nest(xpix  ,ypix+1,face_num);
00720       pix[3] = xyf2nest(xpix+1,ypix+1,face_num);
00721       }
00722     }
00723   <span class="keywordflow">else</span>
00724     {
00725     <span class="keywordtype">int</span> xpix=int(ix-0.5), ypix=int(iy-0.5);
00726     xpix=max(0,min(<a class="code" href="classHealpix__Base.html#p1">nside_</a>-1,xpix));
00727     ypix=max(0,min(<a class="code" href="classHealpix__Base.html#p1">nside_</a>-1,ypix));
00728     <span class="keywordtype">int</span> pixnr = (<a class="code" href="classHealpix__Base.html#p7">scheme_</a>==RING) ?
00729       xyf2ring(xpix,ypix,face_num) : xyf2nest(xpix,ypix,face_num);
00730     <a class="codeRef" doxygen="cxxsupport.tag:../cxxsupport/" href="../cxxsupport/classfix__arr.html">fix_arr&lt;int,8&gt;</a> nb;
00731     <a class="code" href="classHealpix__Base.html#a16">neighbors</a> (pixnr,nb);
00732 
00733     <span class="keywordtype">double</span> xdiff=ix-0.5-xpix, ydiff=iy-0.5-ypix;
00734     <span class="keywordflow">if</span> (xdiff&gt;0)
00735       {
00736       <span class="keywordflow">if</span> (ydiff&gt;0)
00737         add_weights(pixnr,nb[4],nb[2],nb[3], xdiff, ydiff,pix,wgt);
00738       <span class="keywordflow">else</span>
00739         add_weights(pixnr,nb[4],nb[6],nb[5], xdiff,-ydiff,pix,wgt);
00740       }
00741     <span class="keywordflow">else</span>
00742       {
00743       <span class="keywordflow">if</span> (ydiff&gt;0)
00744         add_weights(pixnr,nb[0],nb[2],nb[1],-xdiff, ydiff,pix,wgt);
00745       <span class="keywordflow">else</span>
00746         add_weights(pixnr,nb[0],nb[6],nb[7],-xdiff,-ydiff,pix,wgt);
00747       }
00748     }
00749   }
00750 
<a name="l00751"></a><a class="code" href="classHealpix__Base.html#a15">00751</a> <span class="keywordtype">void</span> <a class="code" href="classHealpix__Base.html#a15">Healpix_Base::get_ring_info2</a> (<span class="keywordtype">int</span> ring, <span class="keywordtype">int</span> &amp;startpix, <span class="keywordtype">int</span> &amp;ringpix,
00752   <span class="keywordtype">double</span> &amp;theta, <span class="keywordtype">bool</span> &amp;shifted)<span class="keyword"> const</span>
00753 <span class="keyword">  </span>{
00754   <span class="keywordtype">int</span> northring = (ring&gt;2*nside_) ? 4*<a class="code" href="classHealpix__Base.html#p1">nside_</a>-ring : ring;
00755   <span class="keywordflow">if</span> (northring &lt; nside_)
00756     {
00757     theta = acos(1 - northring*northring*fact2_);
00758     ringpix = 4*northring;
00759     shifted = <span class="keyword">true</span>;
00760     startpix = 2*northring*(northring-1);
00761     }
00762   <span class="keywordflow">else</span>
00763     {
00764     theta = acos((2*<a class="code" href="classHealpix__Base.html#p1">nside_</a>-northring)*fact1_);
00765     ringpix = 4*nside_;
00766     shifted = ((northring-nside_) &amp; 1) == 0;
00767     startpix = ncap_ + (northring-nside_)*ringpix;
00768     }
00769   <span class="keywordflow">if</span> (northring != ring) <span class="comment">// southern hemisphere</span>
00770     {
00771     theta = pi-theta;
00772     startpix = npix_ - startpix - ringpix;
00773     }
00774   }
00775 
<a name="l00776"></a><a class="code" href="classHealpix__Base.html#a18">00776</a> <span class="keywordtype">void</span> <a class="code" href="classHealpix__Base.html#a18">Healpix_Base::get_interpol2</a> (<span class="keyword">const</span> <a class="codeRef" doxygen="cxxsupport.tag:../cxxsupport/" href="../cxxsupport/classpointing.html">pointing</a> &amp;ptg, <a class="codeRef" doxygen="cxxsupport.tag:../cxxsupport/" href="../cxxsupport/classfix__arr.html">fix_arr&lt;int,4&gt;</a> &amp;pix,
00777   <a class="codeRef" doxygen="cxxsupport.tag:../cxxsupport/" href="../cxxsupport/classfix__arr.html">fix_arr&lt;double,4&gt;</a> &amp;wgt)<span class="keyword"> const</span>
00778 <span class="keyword">  </span>{
00779   <span class="keywordtype">double</span> z = cos (ptg.<a class="codeRef" doxygen="cxxsupport.tag:../cxxsupport/" href="../cxxsupport/classpointing.html#o0">theta</a>);
00780   <span class="keywordtype">int</span> ir1 = ring_above(z);
00781   <span class="keywordtype">int</span> ir2 = ir1+1;
00782   <span class="keywordtype">double</span> theta1, theta2, w1, tmp, dphi;
00783   <span class="keywordtype">int</span> sp,nr;
00784   <span class="keywordtype">bool</span> shift;
00785   <span class="keywordtype">int</span> i1,i2;
00786   <span class="keywordflow">if</span> (ir1&gt;0)
00787     {
00788     <a class="code" href="classHealpix__Base.html#a15">get_ring_info2</a> (ir1, sp, nr, theta1, shift);
00789     dphi = twopi/nr;
00790     tmp = (ptg.<a class="codeRef" doxygen="cxxsupport.tag:../cxxsupport/" href="../cxxsupport/classpointing.html#o1">phi</a>/dphi - .5*shift);
00791     i1 = (tmp&lt;0) ? int(tmp)-1 : int(tmp);
00792     w1 = (ptg.<a class="codeRef" doxygen="cxxsupport.tag:../cxxsupport/" href="../cxxsupport/classpointing.html#o1">phi</a>-(i1+.5*shift)*dphi)/dphi;
00793     i2 = i1+1;
00794     <span class="keywordflow">if</span> (i1&lt;0) i1 +=nr;
00795     <span class="keywordflow">if</span> (i2&gt;=nr) i2 -=nr;
00796     pix[0] = sp+i1; pix[1] = sp+i2;
00797     wgt[0] = 1-w1; wgt[1] = w1;
00798     }
00799   <span class="keywordflow">if</span> (ir2&lt;(4*nside_))
00800     {
00801     <a class="code" href="classHealpix__Base.html#a15">get_ring_info2</a> (ir2, sp, nr, theta2, shift);
00802     dphi = twopi/nr;
00803     tmp = (ptg.<a class="codeRef" doxygen="cxxsupport.tag:../cxxsupport/" href="../cxxsupport/classpointing.html#o1">phi</a>/dphi - .5*shift);
00804     i1 = (tmp&lt;0) ? int(tmp)-1 : int(tmp);
00805     w1 = (ptg.<a class="codeRef" doxygen="cxxsupport.tag:../cxxsupport/" href="../cxxsupport/classpointing.html#o1">phi</a>-(i1+.5*shift)*dphi)/dphi;
00806     i2 = i1+1;
00807     <span class="keywordflow">if</span> (i1&lt;0) i1 +=nr;
00808     <span class="keywordflow">if</span> (i2&gt;=nr) i2 -=nr;
00809     pix[2] = sp+i1; pix[3] = sp+i2;
00810     wgt[2] = 1-w1; wgt[3] = w1;
00811     }
00812 
00813   <span class="keywordflow">if</span> (ir1==0)
00814     {
00815     <span class="keywordtype">double</span> wtheta = ptg.<a class="codeRef" doxygen="cxxsupport.tag:../cxxsupport/" href="../cxxsupport/classpointing.html#o0">theta</a>/theta2;
00816     wgt[2] *= wtheta; wgt[3] *= wtheta;
00817     <span class="keywordtype">double</span> fac = (1-wtheta)*0.25;
00818     wgt[0] = fac; wgt[1] = fac; wgt[2] += fac; wgt[3] +=fac;
00819     pix[0] = (pix[2]+2)%4;
00820     pix[1] = (pix[3]+2)%4;
00821     }
00822   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ir2==4*nside_)
00823     {
00824     <span class="keywordtype">double</span> wtheta = (ptg.<a class="codeRef" doxygen="cxxsupport.tag:../cxxsupport/" href="../cxxsupport/classpointing.html#o0">theta</a>-theta1)/(pi-theta1);
00825     wgt[0] *= (1-wtheta); wgt[1] *= (1-wtheta);
00826     <span class="keywordtype">double</span> fac = wtheta*0.25;
00827     wgt[0] += fac; wgt[1] += fac; wgt[2] = fac; wgt[3] =fac;
00828     pix[2] = ((pix[0]+2)&amp;3)+npix_-4;
00829     pix[3] = ((pix[1]+2)&amp;3)+npix_-4;
00830     }
00831   <span class="keywordflow">else</span>
00832     {
00833     <span class="keywordtype">double</span> wtheta = (ptg.<a class="codeRef" doxygen="cxxsupport.tag:../cxxsupport/" href="../cxxsupport/classpointing.html#o0">theta</a>-theta1)/(theta2-theta1);
00834     wgt[0] *= (1-wtheta); wgt[1] *= (1-wtheta);
00835     wgt[2] *= wtheta; wgt[3] *= wtheta;
00836     }
00837 
00838   <span class="keywordflow">if</span> (<a class="code" href="classHealpix__Base.html#p7">scheme_</a>==NEST)
00839     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> m=0; m&lt;pix.<a class="codeRef" doxygen="cxxsupport.tag:../cxxsupport/" href="../cxxsupport/classfix__arr.html#a0">size</a>(); ++m)
00840       pix[m] = <a class="code" href="classHealpix__Base.html#a6">ring2nest</a>(pix[m]);
00841   }
</pre></div><hr><address style="align: right;"><small>
Generated on Fri Jul 8 09:37:15 2005 for Healpix C++
</a> </small></address>
</body>
</html>
